<#
Remediate vulnerable Microsoft Teams versions + clear Defender evidence.
- Removes any Teams version NOT in $ApprovedVersions (per-user, MSI, MSIX)
- Cleans registry for all user hives (even when the user is not logged in)
- Removes ProgramData ghost installs
- Removes AppX/MSIX WindowsApps versions with SYSTEM ACL FIX
#>

# ------- CONFIG -------
$ApprovedVersions = @(
  "25275.2601.4002.2815","25290.205.4069.4894","25212.2204.3869.2204","25241.203.3947.4411",
  "25255.703.3978.7153","25126.1415.3698.6812","25198.1112.3855.2900","25163.3611.3774.6315",
  "25227.203.3915.2444","25189.1109.3837.4725","25185.410.3812.8024","25227.205.3936.6644"
)

$Log = "C:\ProgramData\UFCW_TeamsCleanup.log"
New-Item -ItemType Directory -Path (Split-Path $Log) -Force | Out-Null

function Log {
    param([string]$m)
    ("[{0}] {1}" -f (Get-Date -f "yyyy-MM-dd HH:mm:ss"),$m) | Out-File $Log -Append
}

Log "===== Starting Teams remediation run ====="


# ------- HELPERS -------
function Remove-PerUserTeams {
  param([string]$profilePath)

  $exe = Join-Path $profilePath "AppData\Local\Microsoft\Teams\current\Teams.exe"
  if (!(Test-Path $exe)) { return }

  $ver = (Get-Item $exe).VersionInfo.ProductVersion
  Log "User '$profilePath' Teams.exe version: $ver"

  if ($ApprovedVersions -contains $ver) {
    Log "Approved version; skip per-user removal."
    return
  }

  $upd = Join-Path $profilePath "AppData\Local\Microsoft\Teams\Update.exe"
  if (Test-Path $upd) {
    Start-Process $upd -ArgumentList "--uninstall -s" -Wait -ErrorAction SilentlyContinue
    Log "Executed Update.exe --uninstall"
  }

  foreach ($p in @("AppData\Local\Microsoft\Teams","AppData\Roaming\Microsoft\Teams")) {
    $full = Join-Path $profilePath $p
    if (Test-Path $full) {
      Remove-Item $full -Recurse -Force -ErrorAction SilentlyContinue
      Log "Deleted folder: $full"
    }
  }
}


function Clean-RegistryForHive {
  param([string]$HiveRoot)

  $targets = @(
    "$HiveRoot\Software\Microsoft\Windows\CurrentVersion\Uninstall\Teams",
    "$HiveRoot\Software\Microsoft\Office\Teams",
    "$HiveRoot\Software\Microsoft\Teams",
    "$HiveRoot\Software\Microsoft\Windows\CurrentVersion\Run"
  )

  foreach ($key in $targets) {
    if (Test-Path $key) {
      Remove-Item $key -Recurse -Force -ErrorAction SilentlyContinue
      Log "Removed registry key in hive: $key"
    }
  }
}

function Load-UserHive {
  param($Profile)

  $nt = Join-Path $Profile.LocalPath "NTUSER.DAT"
  if (!(Test-Path $nt)) { return $null }

  $mountName = "TempHive-" + ([IO.Path]::GetFileName($Profile.LocalPath))
  $mount = "HKU\$mountName"

  reg.exe load $mount $nt 2>&1 | Out-Null
  if ($LASTEXITCODE -eq 0) {
    Log "Loaded hive: $mount"
    return "HKU:\$mountName"
  }

  return $null
}

function Unload-UserHive {
  param([string]$MountHKU)

  if ($MountHKU -match "^HKU:\\(.+)$") {
    $raw = "HKU\" + $Matches[1]
    reg.exe unload $raw 2>&1 | Out-Null
    Log "Unloaded hive: $raw"
  }
}


# ------- PER-USER CLEANUP -------
Get-CimInstance Win32_UserProfile |
  Where-Object { $_.LocalPath -like "C:\Users\*" -and -not $_.Special } |
  ForEach-Object {
    $p = $_

    Remove-PerUserTeams -profilePath $p.LocalPath

    $hive = Load-UserHive -Profile $p
    if ($hive) {
      Clean-RegistryForHive -HiveRoot $hive
      Unload-UserHive -MountHKU $hive
    }
  }


# ------- MACHINE-WIDE INSTALLER -------
$uninstRoots = @(
  "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall",
  "HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall"
)

foreach ($root in $uninstRoots) {
  if (Test-Path $root) {
    Get-ChildItem $root | ForEach-Object {
      try {
        $p = Get-ItemProperty $_.PsPath -ErrorAction SilentlyContinue
        if ($p.DisplayName -match "Teams Machine-Wide Installer") {
          $dv = $p.DisplayVersion
          if ($ApprovedVersions -notcontains $dv) {
            Log "Removing machine-wide installer (version $dv)"
            $cmd = $p.UninstallString
            if ($cmd) {
              Start-Process "cmd.exe" -ArgumentList "/c $cmd /qn /norestart" -Wait
            }
            Remove-Item $_.PsPath -Recurse -Force
          }
        }
      } catch {}
    }
  }
}


# ------- WINDOWSAPPS (MSIX) â€” WITH SYSTEM FIX -------
$appsDir = "C:\Program Files\WindowsApps"

if (Test-Path $appsDir) {
  Get-ChildItem $appsDir -Directory | Where-Object { $_.Name -like "msteams*" } | ForEach-Object {

    if ($_.Name -match "\d+\.\d+\.\d+\.\d+") {
      $ver = $matches[0]

      if ($ApprovedVersions -notcontains $ver) {

        Log "Removing MSIX folder ($ver): $($_.Name)"

        # SYSTEM ACL FIX
        takeown /f $_.FullName /r /d y | Out-Null
        icacls $_.FullName /grant SYSTEM:F /t /c | Out-Null
        icacls $_.FullName /grant administrators:F /t /c | Out-Null
        attrib -r -s -h $_.FullName /d /s | Out-Null

        Remove-Item $_.FullName -Recurse -Force -ErrorAction SilentlyContinue
      }
      else {
        Log "Keeping approved MSIX version: $ver"
      }
    }
  }
}


# ------- PROGRAMDATA GHOST INSTALLS -------
$pdRoot = "C:\ProgramData"
Get-ChildItem $pdRoot -Directory | ForEach-Object {
  $teams = Join-Path $_.FullName "Microsoft\Teams\current\Teams.exe"
  if (Test-Path $teams) {
    $rootFolder = Join-Path $_.FullName "Microsoft\Teams"
    Log "Removing ProgramData Teams folder: $rootFolder"
    Remove-Item $rootFolder -Recurse -Force -ErrorAction SilentlyContinue
  }
}


# ------- APPX REGISTRY CLEANUP -------
$AppxStores = @(
  "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Appx\AppxAllUserStore\Applications",
  "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Appx\AppxAllUserStore\DeployedPackages"
)

foreach ($store in $AppxStores) {
  if (Test-Path $store) {
    Get-ChildItem $store | Where-Object { $_.PSChildName -like "*msteams*" } | ForEach-Object {

      $ver = $null
      if ($_.PSChildName -match "\d+\.\d+\.\d+\.\d+") { $ver = $matches[0] }

      if ($ApprovedVersions -notcontains $ver) {
        Log "Removing AppX store entry: $($_.PSChildName)"
        Remove-Item $_.PsPath -Recurse -Force -ErrorAction SilentlyContinue
      }
      else {
        Log "Keeping AppX entry (approved): $ver"
      }
    }
  }
}


# ------- EXTRA HKLM/HKCU CLEANUP -------
$extraRoots = @(
  "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall",
  "HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall",
  "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall"
)

foreach ($root in $extraRoots) {
  if (Test-Path $root) {
    Get-ChildItem $root | ForEach-Object {
      try {
        $p = Get-ItemProperty $_.PsPath
        if ($p.DisplayName -match "Teams") {
          $ver = $p.DisplayVersion
          if ($ApprovedVersions -notcontains $ver) {
            Log "Removing stale uninstall key: $($_.PsPath)"
            Remove-Item $_.PsPath -Recurse -Force -ErrorAction SilentlyContinue
          }
        }
      } catch {}
    }
  }
}


# ------- HKU CLEANUP -------
Log "Cleaning HKU uninstall keys..."

Get-ChildItem "HKU:\" | ForEach-Object {
  $key = "HKU:\$($_.PSChildName)\Software\Microsoft\Windows\CurrentVersion\Uninstall\Teams"
  if (Test-Path $key) {
    try {
      $v = (Get-ItemProperty $key).DisplayVersion
      if ($ApprovedVersions -notcontains $v) {
        Log "Removing HKU uninstall key for SID $($_.PSChildName) (version $v)"
        Remove-Item $key -Recurse -Force -ErrorAction SilentlyContinue
      }
    } catch {}
  }
}


Log "===== Teams remediation complete ====="
